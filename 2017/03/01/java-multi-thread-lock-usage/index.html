<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Lock对象也能实现同步的效果，而且在使用上更加方便。 技术点：  ReentrantLock类的使用 ReentrantReadWriteLock类的使用  使用ReentrantLock类在Java多线程中，可以使用synchronized关键字来实现线程之间同步互斥，ReentrantLock类也能达到同样的效果，并且在扩展功能上也更加强大，比如具有嗅探锁定、多路分支通知等功能，而且在使用上">
<meta property="og:type" content="article">
<meta property="og:title" content="Java多线程 - Lock的使用">
<meta property="og:url" content="https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/index.html">
<meta property="og:site_name" content="YXiao&#39;s Blog">
<meta property="og:description" content="Lock对象也能实现同步的效果，而且在使用上更加方便。 技术点：  ReentrantLock类的使用 ReentrantReadWriteLock类的使用  使用ReentrantLock类在Java多线程中，可以使用synchronized关键字来实现线程之间同步互斥，ReentrantLock类也能达到同样的效果，并且在扩展功能上也更加强大，比如具有嗅探锁定、多路分支通知等功能，而且在使用上">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-03-01T14:14:09.000Z">
<meta property="article:modified_time" content="2020-03-02T09:46:17.326Z">
<meta property="article:author" content="yxiao">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Java多线程 - Lock的使用</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/categories/">目录</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2017/08/17/jvm-optimization-base-intro/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2017/01/19/python-shuffle-algorithms/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/&text=Java多线程 - Lock的使用" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/&title=Java多线程 - Lock的使用" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java多线程 - Lock的使用&body=Check out this article: https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#使用ReentrantLock类"><span class="toc-number">1.</span> <span class="toc-text">使用ReentrantLock类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用ReentrantLock进行同步"><span class="toc-number">1.1.</span> <span class="toc-text">使用ReentrantLock进行同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Condition实现wait-notify"><span class="toc-number">1.2.</span> <span class="toc-text">使用Condition实现wait&#x2F;notify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#公平锁与非公平锁"><span class="toc-number">1.3.</span> <span class="toc-text">公平锁与非公平锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#几个ReentrantLock常用方法"><span class="toc-number">1.4.</span> <span class="toc-text">几个ReentrantLock常用方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用ReentrantReadWriteLock类"><span class="toc-number">2.</span> <span class="toc-text">使用ReentrantReadWriteLock类</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Java多线程 - Lock的使用
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">YXiao's Blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2017-03-01T14:14:09.000Z" itemprop="datePublished">2017-03-01</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Java/">Java</a> › <a class="category-link" href="/categories/Java/Concurrency/">Concurrency</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Lock对象也能实现同步的效果，而且在使用上更加方便。</p>
<p>技术点：</p>
<ul>
<li>ReentrantLock类的使用</li>
<li>ReentrantReadWriteLock类的使用</li>
</ul>
<h1 id="使用ReentrantLock类"><a href="#使用ReentrantLock类" class="headerlink" title="使用ReentrantLock类"></a>使用ReentrantLock类</h1><p>在Java多线程中，可以使用synchronized关键字来实现线程之间同步互斥，ReentrantLock类也能达到同样的效果，并且在扩展功能上也更加强大，比如具有嗅探锁定、多路分支通知等功能，而且在使用上synchronized更加的灵活。</p>
<h2 id="使用ReentrantLock进行同步"><a href="#使用ReentrantLock进行同步" class="headerlink" title="使用ReentrantLock进行同步"></a>使用ReentrantLock进行同步</h2><p>调用ReentrantLock对象的lock()方法获得锁，调用unlock()方法释放锁。</p>
<p>调用lock.lock()代码的线程就持有了“对象监视器”，其他线程只有等待锁被释放时再次争抢。效果和使用synchronized关键字一样，线程之间还是顺序执行的。</p>
<h2 id="使用Condition实现wait-notify"><a href="#使用Condition实现wait-notify" class="headerlink" title="使用Condition实现wait/notify"></a>使用Condition实现wait/notify</h2><p>关键字synchronized与wait()和notify()/notifyAll()方法相结合可以实现等待/通知模式，类ReentrantLock也可以实现同样的功能，但需要借助于Condition对象。Condition类具有更好的灵活性，比如可以实现多路通知功能，也就是在一个Lock对象里面可以创建多个Condition(即对象监视器)实例，线程对象可以注册在指定的Condition中，从而可以有选择性地进行线程通知，在调度线程上更加灵活。</p>
<p><strong>Condition和notify方式的区别：</strong></p>
<p>在使用notify()/notifyAll()方法进行通知时，被通知的线程是由JVM随机选择的。但使用ReentrantLock结合Condition类是可以实现“选择性通知”。</p>
<p>而synchronized关键字就相当于整个Lock对象中只有一个单一的Condition对象，所有的线程都注册在它一个对象的身上。线程开始notifyAll()时，需要通知所有的WAITING线程，没有选择权，会造成相当大的效率问题。</p>
<p>在调用condition.await()方法出现IllegalMonitorStateException异常出错，解决的办法是在condition.await()方法调用之前调用lock.lock()代码获得同步监视器。</p>
<p>Condition实现wait/notify(等价图)：</p>
<table>
<thead>
<tr>
<th align="left">Object类的方法</th>
<th align="left">Condition类的方法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">wait()</td>
<td align="left">await()</td>
</tr>
<tr>
<td align="left">wait(long timeout)</td>
<td align="left">await(long time, TimeUnit unit)</td>
</tr>
<tr>
<td align="left">notify()</td>
<td align="left">signal()</td>
</tr>
<tr>
<td align="left">notifyAll()</td>
<td align="left">signalAll()</td>
</tr>
</tbody></table>
<h2 id="公平锁与非公平锁"><a href="#公平锁与非公平锁" class="headerlink" title="公平锁与非公平锁"></a>公平锁与非公平锁</h2><p>锁Lock分为“公平锁”和“非公平锁”，公平锁获取锁的顺序是按照线程加锁的顺序来分配的，即FIFO。而非公平锁就是一种获取锁的抢占机制，是随机获得锁的，这种方式可能造成某些线程一直拿不到锁。ReentrantLock默认使用的是“非公平锁”。</p>
<p>“非公平锁”性能比“公平锁”高5-10倍，因为公平锁需要在多核的情况下维护一个队列，并且在恢复一个被挂起的线程与该线程真正运行起来之间存在着严重的延迟。</p>
<p>实现方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ReentrantLock(<span class="keyword">boolean</span> isFair)</span><br></pre></td></tr></table></figure>

<h2 id="几个ReentrantLock常用方法"><a href="#几个ReentrantLock常用方法" class="headerlink" title="几个ReentrantLock常用方法"></a>几个ReentrantLock常用方法</h2><ul>
<li>getHoldCount()：查询当前线程保持此锁定的个数，也就是lock()被调用的次数；</li>
<li>getQueueLength()：返回正等待获取此锁的线程个数，比如5个线程，1个线程首先执行await()方法，那么调用getQueueLength()方法后的返回值是4，说明有4个线程同时在等待lock的释放；</li>
<li>getWaitQueueLength(Condition condition)：返回等待与此锁给定条件Condition的线程个数，比如5个线程，每个线程都执行了同一个condition对象的await()方法，则调用getWaitQueueLength(Condition condition)方法时返回的int值是5；</li>
<li>hasQueuedThread(Thread thread)：查询指定的线程是否正在等待此锁；</li>
<li>hasQueuedThreads()：查询是否有线程等待此锁；</li>
<li>hasWaiters(Condition condition)：查询是否有线程正在等待与此锁有关的condition条件；</li>
<li>isFair()：判断是不是公平锁；</li>
<li>isHeldByCurrentThread()：查询当前线程是否持有此锁；</li>
<li>isLocked()：查询此锁是否被任意线程持有。</li>
</ul>
<h1 id="使用ReentrantReadWriteLock类"><a href="#使用ReentrantReadWriteLock类" class="headerlink" title="使用ReentrantReadWriteLock类"></a>使用ReentrantReadWriteLock类</h1><p>类ReentrantLock具有完全互斥排它的效果，即同一时间只有一个线程在执行ReentrantLock.lock()方法后面的任务（同synchronized关键字）。这样做虽然保证了实例变量的线程安全性，但效率确实非常低下的。所以在JDK中提供了一种读写锁ReentrantReadWriteLock类，使用它可以加快运行效率，在某些不需要操作实例变量的方法中，完全可以使用读写锁ReentrantReadWriteLock来提升该方法的运行速度。</p>
<p>读写锁有两个锁：一个是读操作相关的锁，也称为<strong>共享锁</strong>；另一个是写操作相关的锁，也称为<strong>排他锁</strong>。</p>
<p>也就是多个读锁之间不互斥，读锁与写锁互斥，写锁与写锁互斥。在没有线程Thread进行写入操作时，进行读取操作的多个Thread都可以获取该锁，而进行写操作的Thread只有在获取写锁后才能进行写入操作。即多个Thread可以同时进行读取操作，但是同一时刻只允许一个Thread进行写入操作。</p>
<p>用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  lock.readLock().lock();</span><br><span class="line">  <span class="comment">// lock.writeLock().lock();</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  lock.readLock().unlock();</span><br><span class="line">  <span class="comment">// lock.writeLock().unlock();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/categories/">目录</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#使用ReentrantLock类"><span class="toc-number">1.</span> <span class="toc-text">使用ReentrantLock类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用ReentrantLock进行同步"><span class="toc-number">1.1.</span> <span class="toc-text">使用ReentrantLock进行同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Condition实现wait-notify"><span class="toc-number">1.2.</span> <span class="toc-text">使用Condition实现wait&#x2F;notify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#公平锁与非公平锁"><span class="toc-number">1.3.</span> <span class="toc-text">公平锁与非公平锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#几个ReentrantLock常用方法"><span class="toc-number">1.4.</span> <span class="toc-text">几个ReentrantLock常用方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用ReentrantReadWriteLock类"><span class="toc-number">2.</span> <span class="toc-text">使用ReentrantReadWriteLock类</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/&text=Java多线程 - Lock的使用" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/&title=Java多线程 - Lock的使用" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Java多线程 - Lock的使用&body=Check out this article: https://blog.yangx.site/2017/03/01/java-multi-thread-lock-usage/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 yxiao
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">文章</a></li>
         
          <li><a href="/categories/">目录</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-159372775-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
